// Create namespace
var heeApp=heeApp||{};(function(){heeApp.view={settings:{sound:["sound/he.mp3","sound/onara.mp3"],ws:"http://ec2-54-248-9-204.ap-northeast-1.compute.amazonaws.com",onaraInterval:20},init:function(){var a=this;this.data;this.state=new heeApp.State(this.render,this);this.u=heeApp.util;this.socket=io.connect(this.settings.ws);this.u.getJSON("data/data.json",function(b){var c=JSON.parse(b);a.data=c;a.render(c)})},render:function(){var a=this.u,b=this.state;if(a.isiPhone()||a.isAndroid())location.hash="#button";a.addClass(a.getEl("#contents"),b.current);this[b.current]&&this[b.current](this.data)},master:function(a){var b=this,c=b.u,d=b.socket;d.on("connect",function(){c.addClass(c.getEl("#contents"),"connected");c.getEl("#paging").addEventListener("click",function(a){a.target.parentNode.className==="back"?d.emit("changePage",parseInt(b.state.params[0])-1):d.emit("changePage",parseInt(b.state.params[0])+1)},!1)});d.on("disconnect",function(a){c.removeClass(c.getEl("#contents"),"connected")});this.summary(a);this.screen(a)},detail:function(a){var b=this.u,c=this.state.current;b.log.info("load "+c);var d=parseInt(this.state.params[0]),a=this.data.data[d];b.log.debug(a);b.getEl("#detail > h1").innerText=a.title;if(d===0)b.addClass(b.getEl("#paging li:first-child"),"hidden");else{b.removeClass(b.getEl("#paging li:first-child"),"hidden");b.getEl("#paging li:first-child a").href="/#"+c+"/"+(parseInt(d)-1)}if(d===this.data.data.length-1)b.addClass(b.getEl("#paging .next"),"hidden");else{b.removeClass(b.getEl("#paging .next"),"hidden");b.getEl("#paging .next a").href="/#"+c+"/"+(parseInt(d)+1)}var e=b.getEl("#detail > .members");e.innerHTML="";var f=document.createDocumentFragment();a.members.forEach(function(a){var b=document.createElement("li");b.innerText=a;f.appendChild(b)});e.appendChild(f);e=b.getEl("#detail > .urls");e.innerHTML="";if(a.urls){f=document.createDocumentFragment();a.urls.forEach(function(a){var b=document.createElement("li"),c=document.createElement("a");c.innerText=a;c.href=a;b.appendChild(c);f.appendChild(b)});e.appendChild(f)}if(a.auth){b.getEl("#detail > .auth .id").innerText=a.auth[0];b.getEl("#detail > .auth .password").innerText=a.auth[1];b.removeClass(b.getEl("#detail > .auth"),"hidden")}else b.addClass(b.getEl("#detail > .auth"),"hidden");if(a.login){b.getEl("#detail > .login .id").innerText=a.login[0];b.getEl("#detail > .login .password").innerText=a.login[1];b.removeClass(b.getEl("#detail > .login"),"hidden")}else b.addClass(b.getEl("#detail > .login"),"hidden");e=b.getEl("#detail > .techs");e.innerHTML="";f=document.createDocumentFragment();a.techs.forEach(function(a){var b=document.createElement("li");b.innerText=a;f.appendChild(b)});e.appendChild(f);b.getEl("#detail > .description").innerText=a.description},button:function(){var a=this.u;a.log.info("load "+this.state.current);var b=this.socket;b.on("connect",function(){a.addClass(a.getEl("#contents"),"connected");var c=document.getElementById("btnHee");c.addEventListener("click",function(){b.emit("hee")},!1)});b.on("disconnect",function(b){a.removeClass(a.getEl("#contents"),"connected")})},screen:function(a){var b=this,c=this.u,d=this.state.params[0],e={};c.log.info("load "+this.state.current);var f=[];b.settings.sound.forEach(function(a){var b=new Audio(a);b.load();b.autoplay=!1;f.push(b)});var g=parseInt(localStorage.getItem(d))||0;c.getEl("#counter").innerText=g;var h=b.socket,i=b.state;h.on("connect",function(){c.addClass(c.getEl("#contents"),"connected");h.on("changePage",function(a){var b=a||i.params[0];location.hash="#"+i.current+"/"+b});h.on("soundPlay",function(){b.state.update();var a=b.state.params[0],d=parseInt(localStorage.getItem(a))||0,e=new heeApp.Counter(d);e.plus();var g=e.getCount();c.getEl("#counter").innerText=e.getCount();localStorage.setItem(a,e.getCount());if(e.getCount()%b.settings.onaraInterval)var h=0;else var h=1;f[h].currentTime=0;f[h].play()})});h.on("disconnect",function(a){c.removeClass(c.getEl("#contents"),"connected")});this.detail(a)},summary:function(a){var b=this.u,c=b.getEl("#summary table"),d=document.createDocumentFragment();for(var e=0,f=a.data.length;e<f;e+=1){var g=document.createElement("tr"),h=document.createElement("th"),i=document.createElement("td");h.innerText=a.data[e].members.join(", ");g.appendChild(h);i.innerText=localStorage.getItem(e)||0;g.appendChild(i);d.appendChild(g)}c.appendChild(d)}};window.addEventListener("load",function(){heeApp.view.init.apply(heeApp.view)},!1)})();